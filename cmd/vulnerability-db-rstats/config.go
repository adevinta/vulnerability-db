/*
Copyright 2020 Adevinta
*/

package main

import (
	"io/ioutil"
	"os"

	log "github.com/sirupsen/logrus"

	"github.com/BurntSushi/toml"
)

type config struct {
	Log logConfig
	DB  dbConfig
}

type logConfig struct {
	Level string
}

type dbConfig struct {
	Dialect string
	Host    string `toml:"host"`
	Port    string `toml:"port"`
	SSLMode string `toml:"sslmode"`
	User    string `toml:"user"`
	Pass    string `toml:"password"`
	Name    string `toml:"name"`
}

func parseConfig(cfgFilePath string) (*config, error) {
	cfgFile, err := os.Open(cfgFilePath)
	if err != nil {
		return nil, err
	}
	defer cfgFile.Close()

	cfgData, err := ioutil.ReadAll(cfgFile)

	var conf config
	if _, err := toml.Decode(string(cfgData[:]), &conf); err != nil {
		return nil, err
	}

	if envVar := os.Getenv("VULNERABILITYDBCONSUMER_DB_HOST"); envVar != "" {
		conf.DB.Host = envVar
	}

	if envVar := os.Getenv("VULNERABILITYDBCONSUMER_DB_PORT"); envVar != "" {
		conf.DB.Port = envVar
	}

	if envVar := os.Getenv("VULNERABILITYDBCONSUMER_DB_USER"); envVar != "" {
		conf.DB.User = envVar
	}

	if envVar := os.Getenv("VULNERABILITYDBCONSUMER_DB_NAME"); envVar != "" {
		conf.DB.Name = envVar
	}

	return &conf, nil
}

// parseLogLevel parses a configured string log level
// and returns the correspondent logrus log level.
// If log level is invalid, default level is Info.
func parseLogLevel(logLevel string) log.Level {
	switch logLevel {
	case "panic":
		return log.PanicLevel
	case "fatal":
		return log.FatalLevel
	case "error":
		return log.ErrorLevel
	case "warn":
		return log.WarnLevel
	case "info":
		return log.InfoLevel
	case "debug":
		return log.DebugLevel
	case "trace":
		return log.TraceLevel
	default:
		return log.InfoLevel
	}
}
