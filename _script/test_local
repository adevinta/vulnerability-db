#!/bin/bash

# Copyright 2021 Adevinta

set -e

host=localhost
port=5432

# setup test db
docker-compose -f $(pwd)/test/docker-compose.yml up -d

echo Waiting for postgres to become available...
while ! nc -z $host $port 2>/dev/null
do
    let elapsed=elapsed+1
    if [ "$elapsed" -gt 90 ] 
    then
        echo "TIMED OUT!"
        exit 1
    fi  
    sleep 1;
done

# run tests
go test -v -tags integration ./...
