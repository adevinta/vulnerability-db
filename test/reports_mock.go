//go:build integration
// +build integration

/*
Copyright 2020 Adevinta
*/

package test

import (
	"strings"

	vulcan "github.com/adevinta/vulcan-report"
	"github.com/adevinta/vulnerability-db/pkg/results"
)

// This file contains a mock implementation of the results client.
// This allows us to test the consumer processor without having to
// interact with results service or any mock HTTP service.
// Instead, mockResultsClient will mock the HTTP request and return
// the reports data for a predefined reports list specified in this
// same file.

// Mock reports client.
type mockResultsClient struct {
	init    bool
	reports map[string]vulcan.Report
}

// Init builds the reports map of:
// {check_id: vulcan.Report}
// for every report specified in the
// mock_reports file.
func (c *mockResultsClient) Init() error {
	c.reports = make(map[string]vulcan.Report)

	for _, reportJSON := range reports {
		var r vulcan.Report
		err := r.UnmarshalJSONTimeAsString([]byte(reportJSON))
		if err != nil {
			return err
		}
		c.reports[r.CheckID] = r
	}

	return nil
}

// Download mocks the results client download method
// fetching data from mock reports.
func (c *mockResultsClient) Download(reportURL string) (vulcan.Report, error) {
	// Load report mocks if they've not
	// been loaded yet.
	if !c.init {
		if err := c.Init(); err != nil {
			return vulcan.Report{}, err
		}
		c.init = true
	}

	// Look for report and return if found.
	// Otherwise, return ErrInvalidRespStatus
	// mocking a bad HTTP response from server.
	reportID := parseReportID(reportURL)
	report, ok := c.reports[reportID]
	if !ok {
		return vulcan.Report{}, results.ErrInvalidRespStatus
	}

	return report, nil
}

// parseReportID extracts the report ID from the request url.
// It assumes that the URL path complies with format:
// /v1/reports/dt=YYYY-MM-DD/scan={scan_id}/{check_id}.json
func parseReportID(url string) string {
	// Split url by resources separator '/'.
	urlParts := strings.Split(url, "/")
	// Get report filename. E.g.: {uuid}.json
	reportFile := urlParts[len(urlParts)-1]
	// Remove .json extension.
	return reportFile[:len(reportFile)-len(".json")]
}

var (
	// Mock reports to be used by the mock results client.
	// An external .json file in this package was discarded
	// in favor of this solution (defining them as a JSON
	// string in a go variable) so we could avoid using FS IO.
	//
	// Some attributes have been removed from report JSON because
	// processor does not parse them from the report but from the
	// check message itself.
	reports = []string{
		// Happy path report.
		`{
			"check_id":"00000000-0000-0000-0000-000000000001",
			"vulnerabilities":
				[
					{
						"summary":"Managed AWS databases using CA about to expire",
						"score":8.0,
						"details":"Managed AWS details",
						"cwe_id": 216,
						"description":"Mock description",
						"references":[],
						"affected_resource":"arn:aws:rds:eu-west-1:123456789012:db:myRDS",
						"resources":[{"name":"resource name"}]
					}
				],
			"start_time":"2020-01-21 16:03:13",
			"end_time":"2020-01-21 16:03:25"
		}`,
		// Report that should set to FIXED the initial finding.
		`{
			"check_id":"00000000-0000-0000-0000-000000000002",
			"vulnerabilities": [],
			"start_time":"2020-01-01 09:00:00",
			"end_time":"2020-01-01 10:00:00"
		}`,
		// Report that adds new finding event to initial finding.
		`{
			"check_id":"00000000-0000-0000-0000-000000000003",
			"vulnerabilities": [
				{
					"summary":"Initial issue",
					"score":7.0,
					"details":"Managed AWS details - modified",
					"cwe_id": 1,
					"description":"Initial issue description",
					"references":[],
					"affected_resource":"www.initial.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-2009-3023"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-02 09:00:00",
			"end_time":"2020-01-02 10:00:00"
		}`,
		// Report that reopens the initial fixed finding.
		`{
			"check_id":"00000000-0000-0000-0000-000000000004",
			"vulnerabilities": [
				{
					"summary":"Initial fixed issue",
					"score":9.0,
					"details":"Initial fixed issue details",
					"cwe_id": 2,
					"description":"Initial fixed issue description",
					"references":[],
					"affected_resource":"www.initial.fixed.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-8888-9999"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that reopens the initial fixed finding via 'cross checktype'.
		`{
			"check_id":"00000000-0000-0000-0000-000000000005",
			"vulnerabilities": [
				{
					"summary":"Initial fixed issue",
					"score":6.0,
					"details":"Initial fixed issue details - modified",
					"cwe_id": 2,
					"description":"Initial fixed issue description",
					"references":[],
					"affected_resource":"www.initial.fixed.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-9999-9999"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that opens multiple new vulnerabilities.
		`{
			"check_id":"00000000-0000-0000-0000-000000000006",
			"vulnerabilities": [
				{
					"summary":"New issue one",
					"score":5.0,
					"details":"New issue one details",
					"cwe_id": 3,
					"description":"New issue one description",
					"references":[],
					"affected_resource":"www.new.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-0000-0001"}], "header": ["CVE"]}]
				},
				{
					"summary":"New issue two",
					"score":6.0,
					"details":"New issue two details",
					"cwe_id": 4,
					"description":"New issue two description",
					"references":[],
					"affected_resource":"www.new.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-0000-0002"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-04 00:00:00",
			"end_time":"2020-01-04 01:00:00"
		}`,
		// Report that reopens the initially EXPIRED finding.
		`{
			"check_id":"00000000-0000-0000-0000-000000000007",
			"vulnerabilities": [
				{
					"summary":"Initial expired issue",
					"score":9.0,
					"details":"Initial expired issue details",
					"cwe_id": 2,
					"description":"Initial expired issue description",
					"references":[],
					"affected_resource":"www.initial.expired.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-1111-1111"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-03-02 00:00:00",
			"end_time":"2020-03-02 01:00:00"
		}`,
		// Report that fixes the initially EXPIRED finding.
		`{
			"check_id":"00000000-0000-0000-0000-000000000008",
			"vulnerabilities": [],
			"start_time":"2020-03-01 00:00:00",
			"end_time":"2020-03-01 01:00:00"
		}`,
		// Report that tries to reopen the initially FALSE_POSITIVE finding.
		`{
			"check_id":"00000000-0000-0000-0000-FFFFFFFFFFFF",
			"vulnerabilities": [
				{
					"summary":"Initial false positive issue",
					"score":9,
					"details":"Initial false positive issue details",
					"cwe_id": 2,
					"description":"Initial false positive description",
					"references":[],
					"affected_resource":"www.initial.false.positive.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-FFFF-FFFF"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-02 00:00:00",
			"end_time":"2020-01-02 01:00:00"
		}`,
		// Report that tries to fix the initially FALSE_POSITIVE finding.
		`{
			"check_id":"00000000-0000-0000-0000-FFFFFFFFFFF0",
			"vulnerabilities": [],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that tries to reopen the initially FALSE_POSITIVE finding - previously FIXED.
		`{
			"check_id":"00000000-0000-0000-0000-FFFFFFFFFFF2",
			"vulnerabilities": [
				{
					"summary":"Initial false positive issue",
					"score":9,
					"details":"Initial false positive issue details",
					"cwe_id": 2,
					"description":"Initial false positive description",
					"references":[],
					"affected_resource":"www.initial.false.positive.2.example.com",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-FFFF-FFFF"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that tries to fix the initially FALSE_POSITIVE finding - previously FIXED.
		`{
			"check_id":"00000000-0000-0000-0000-FFFFFFFFFFF3",
			"vulnerabilities": [],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that reopens false positive due to fingerprint variation.
		`{
			"check_id":"aaaaaaaa-0000-0000-0000-000000000000",
			"vulnerabilities":
				[
					{
						"summary":"Initial false positive issue",
						"score":9.0,
						"details":"",
						"cwe_id": 2,
						"description":"Initial false positive description",
						"references":[],
						"affected_resource":"www.initial.false.positive.example.com",
						"fingerprint":"newMockFingerprint",
						"resources":[]
					}
				],
			"start_time":"2021-01-21 16:03:13",
			"end_time":"2021-01-21 16:03:25"
		}`,
		// Report that triggers migration from v1 model finding to v2.
		`{
			"check_id":"aaaaaaaa-0000-0000-0000-000000000002",
			"vulnerabilities":
				[
					{
						"summary":"Exposed SSH Ports",
						"score":7.0,
						"details":"Exposed SSH Port in 22",
						"cwe_id": 1,
						"description":"An SSH port is accessible from the public internet",
						"references":[],
						"affected_resource":"TCP22",
						"fingerprint":"v2ModelMockFingerprint",
						"resources":[]
					}
				],
			"start_time":"2021-01-21 16:03:13",
			"end_time":"2021-01-21 16:03:25"
		}`,
		// Report that triggers continuation of v1 model finding to v2 model for
		// finding with matching target identifier and affected resource.
		`{
			"check_id":"aaaaaaaa-0000-0000-0000-000000000003",
			"vulnerabilities":
				[
					{
						"summary":"Exposed SSH Ports",
						"score":7.0,
						"details":"Exposed SSH Port in 22",
						"cwe_id": 1,
						"description":"An SSH port is accessible from the public internet",
						"references":[],
						"affected_resource":"www.model.test.example.com",
						"fingerprint":"v2ModelMockFingerprint",
						"resources":[]
					}
				],
			"start_time":"2021-01-22 16:03:13",
			"end_time":"2021-01-22 16:03:25"
		}`,
		// Report that fixes v1 model finding which continued its lifecycle through v2 model.
		`{
			"check_id":"aaaaaaaa-0000-0000-0000-000000000004",
			"vulnerabilities": [],
			"start_time":"2021-02-23 16:00:00",
			"end_time":"2021-02-23 16:03:25"
		}`,
		// Happy path report v2.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000001",
			"vulnerabilities":
				[
					{
						"summary":"Managed AWS databases using CA about to expire v2",
						"score":8.0,
						"details":"Managed AWS details",
						"cwe_id": 216,
						"description":"Mock description v2",
						"references":[],
						"affected_resource":"arn:aws:rds:eu-west-1:123456789012:db:myRDS",
						"affected_resource_string":"MyRDS",
						"fingerprint":"v2MockFingerprint01",
						"resources":[{"name":"resource name"}]
					}
				],
			"start_time":"2020-01-21 16:03:13",
			"end_time":"2020-01-21 16:03:25"
		}`,
		// Report that should set to FIXED the initial v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000002",
			"vulnerabilities": [],
			"start_time":"2020-01-01 09:00:00",
			"end_time":"2020-01-01 10:00:00"
		}`,
		// Report that adds new finding event to initial v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000003",
			"vulnerabilities": [
				{
					"summary":"Initial issue v2",
					"score":7.0,
					"details":"Managed AWS details - modified",
					"cwe_id": 1,
					"description":"Initial issue v2 description",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:vpc/vpc-11223344556677889",
					"fingerprint": "v2InitialFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-2009-3023"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-02 09:00:00",
			"end_time":"2020-01-02 10:00:00"
		}`,
		// Report that reopens the initial fixed v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000004",
			"vulnerabilities": [
				{
					"summary":"Initial fixed issue v2",
					"score":9.0,
					"details":"Initial fixed issue details",
					"cwe_id": 2,
					"description":"Initial fixed issue description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-11223344556677889",
					"fingerprint": "v2FixedFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-8888-9999"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that reopens the initial v2 fixed finding via 'cross checktype'.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000005",
			"vulnerabilities": [
				{
					"summary":"Initial fixed issue v2",
					"score":6.0,
					"details":"Initial fixed issue details - modified",
					"cwe_id": 2,
					"description":"Initial fixed issue description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-11223344556677889",
					"affected_resource_string":"Updated resource",
					"fingerprint": "v2FixedFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-9999-9999"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that opens multiple new v2 vulnerabilities.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000006",
			"vulnerabilities": [
				{
					"summary":"New issue one v2",
					"score":5.0,
					"details":"New issue one details",
					"cwe_id": 3,
					"description":"New issue one description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-1",
					"fingerprint": "v2MockFingerprintA",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-0000-0001"}], "header": ["CVE"]}]
				},
				{
					"summary":"New issue two v2",
					"score":6.0,
					"details":"New issue two details",
					"cwe_id": 4,
					"description":"New issue two description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-2",
					"fingerprint": "v2MockFingerprintB",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-0000-0002"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-04 00:00:00",
			"end_time":"2020-01-04 01:00:00"
		}`,
		// Report that reopens the initially EXPIRED v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000007",
			"vulnerabilities": [
				{
					"summary":"Initial expired issue v2",
					"score":9.0,
					"details":"Initial expired issue details",
					"cwe_id": 2,
					"description":"Initial expired issue description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-1111",
					"fingerprint": "v2ExpiredFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-1111-1111"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-03-02 00:00:00",
			"end_time":"2020-03-02 01:00:00"
		}`,
		// Report that fixes the initially EXPIRED v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000008",
			"vulnerabilities": [],
			"start_time":"2020-03-01 00:00:00",
			"end_time":"2020-03-01 01:00:00"
		}`,
		// Report that should FIX the first initial double v2 finding but keep the second one open.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-000000000009",
			"vulnerabilities": [
				{
					"summary":"Initial double issue v2",
					"score":7,
					"details":"",
					"cwe_id": 1,
					"description":"Initial double issue v2 description",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:333355557777:vpc/vpc-22553311007788996",
					"fingerprint": "v2InitialBis2FP",
					"resources":[]
				}
			],
			"start_time":"2020-01-01 09:00:00",
			"end_time":"2020-01-01 10:00:00"
		}`,
		// Report that tries to reopen the initially FALSE_POSITIVE v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-FFFFFFFFFFFF",
			"vulnerabilities": [
				{
					"summary":"Initial false positive issue v2",
					"score":9,
					"details":"Initial false positive issue details",
					"cwe_id": 2,
					"description":"Initial false positive description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-FFFF",
					"fingerprint": "v2FalseFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-FFFF-FFFF"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-02 00:00:00",
			"end_time":"2020-01-02 01:00:00"
		}`,
		// Report that tries to fix the initially FALSE_POSITIVE v2 finding.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-FFFFFFFFFFF0",
			"vulnerabilities": [],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that tries to reopen the initially FALSE_POSITIVE v2 finding - previously FIXED.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-FFFFFFFFFFF2",
			"vulnerabilities": [
				{
					"summary":"Initial false positive issue v2",
					"score":9,
					"details":"Initial false positive issue details",
					"cwe_id": 2,
					"description":"Initial false positive description v2",
					"references":[],
					"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-FFF2",
					"fingerprint": "v2FalseFixedFP",
					"resources":[{"name":"resource name", "rows": [{"CVE":"CVE-FFFF-FFFF"}], "header": ["CVE"]}]
				}
			],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that tries to fix the initially FALSE_POSITIVE v2 finding - previously FIXED.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-FFFFFFFFFFF3",
			"vulnerabilities": [],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Report that reopens false positive v2 finding due to fingerprint variation.
		`{
			"check_id":"bbbbbbbb-0000-0000-0000-FFFFFFFFFFF4",
			"vulnerabilities":
				[
					{
						"summary":"Initial false positive issue v2",
						"score":9.0,
						"details":"",
						"cwe_id": 2,
						"description":"Initial false positive description v2",
						"references":[],
						"affected_resource":"arn:aws:ec2:region:777788889999:sg/sg-FFFF",
						"fingerprint":"v2FalseChangedFP",
						"resources":[]
					}
				],
			"start_time":"2021-01-21 16:03:13",
			"end_time":"2021-01-21 16:03:25"
		}`,
		// Report that contains a NULL unicode character that must be escaped.
		`{
			"check_id":"uuuuuuuu-0000-0000-0000-000000000001",
			"vulnerabilities":
				[
					{
						"summary":"Unicode character vulnerability",
						"score":6.0,
						"details":"",
						"cwe_id": 2,
						"description":"Unicode character vulnerability description",
						"references":[],
						"affected_resource":"unicode.example.com/encoding",
						"fingerprint":"default",
						"resources":[{"Name":"Unicode character","Header":["String"],"Rows":[{"String":"\\u0000\u0000\u0000\u0000unicodechar\u0002\u0000h)h-C\u0008y\u001e\u0001\u0000\u0000..."}]}]
					}
				],
			"start_time":"2022-01-01 16:03:13",
			"end_time":"2022-01-01 16:03:25"
		}`,
		// Processor Concurrency:
		// Report that adds new finding event to initial finding.
		`{
			"check_id":"10000000-0000-0000-0000-000000000001",
			"vulnerabilities": [
				{
					"summary":"Initial issue",
					"score":7.0,
					"details":"Initial issue details - concurrent",
					"cwe_id": 1,
					"description":"Initial issue description",
					"references":[],
					"affected_resource":"www.initial.example.com",
					"resources":[]
				}
			],
			"start_time":"2020-01-02 00:00:00",
			"end_time":"2020-01-02 01:00:00"
		}`,
		// Processor Concurrency:
		// Report that fixes initial finding.
		`{
			"check_id":"10000000-0000-0000-0000-000000000002",
			"vulnerabilities": [],
			"start_time":"2020-01-03 00:00:00",
			"end_time":"2020-01-03 01:00:00"
		}`,
		// Processor Concurrency:
		// Report that reopens initial finding.
		`{
			"check_id":"10000000-0000-0000-0000-000000000003",
			"vulnerabilities": [
				{
					"summary":"Initial issue",
					"score":7.0,
					"details":"Initial issue details - concurrent",
					"cwe_id": 1,
					"description":"Initial issue description",
					"references":[],
					"affected_resource":"www.initial.example.com",
					"resources":[]
				}
			],
			"start_time":"2020-01-04 00:00:00",
			"end_time":"2020-01-04 01:00:00"
		}`,
		// Processor Concurrency:
		// Report that adds new finding event to initial finding.
		`{
			"check_id":"10000000-0000-0000-0000-000000000004",
			"vulnerabilities": [
				{
					"summary":"Initial issue",
					"score":7.0,
					"details":"Initial issue details - concurrent",
					"cwe_id": 1,
					"description":"Initial issue description",
					"references":[],
					"affected_resource":"www.initial.example.com",
					"resources":[]
				}
			],
			"start_time":"2020-01-05 00:00:00",
			"end_time":"2020-01-05 01:00:00"
		}`,
		// Processor Concurrency:
		// Report that fixes initial finding.
		`{
			"check_id":"10000000-0000-0000-0000-000000000005",
			"vulnerabilities": [],
			"start_time":"2020-01-06 00:00:00",
			"end_time":"2020-01-06 01:00:00"
		}`,
	}
)
