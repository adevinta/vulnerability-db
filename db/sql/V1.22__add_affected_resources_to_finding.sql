-- Creates the affected_resource column
ALTER TABLE findings ADD affected_resource text;

-- Set affected_resource as the resource identifier
UPDATE findings SET affected_resource = (select t.identifier from targets t where t.id = findings.target_id) where affected_resource = '' or affected_resource is null;

-- Add NOT NULL and NOT EMPTY constraints to affected_resource column
ALTER TABLE findings ALTER COLUMN affected_resource SET NOT NULL;
ALTER TABLE findings ADD CONSTRAINT check_affected_resource_not_empty CHECK (affected_resource <> '');

-- Recreate the unique constraint for findings
ALTER TABLE findings DROP CONSTRAINT findings_issue_id_target_id_key;
ALTER TABLE findings ADD CONSTRAINT findings_unique_key UNIQUE (affected_resource,issue_id,target_id);
